<!doctype html>
<html lang="en">
<head>
Â  <meta charset="utf-8" />
Â  <meta name="viewport" content="width=device-width,initial-scale=1" />
Â  <title>OKX USDT Perpetual Tracker</title>
Â  <style>
Â  Â  :root{
Â  Â  Â  --bg:#0b1220; --card:#0f1724; --muted:#9aa4b2; --accent:#06b6d4;
Â  Â  Â  --green:#16a34a; --red:#ef4444; --yellow:#f59e0b; --glass: rgba(255,255,255,0.03);
Â  Â  Â  font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
Â  Â  }
Â  Â  html,body{height:100%;margin:0;background:linear-gradient(180deg,#030615 0%,#071126 100%);color:#e6eef6}
Â  Â  .wrap{max-width:1100px;margin:28px auto;padding:20px;}
Â  Â  header{display:flex;align-items:center;justify-content:space-between;gap:12px}
Â  Â  h1{font-size:20px;margin:0;color:var(--accent)}
Â  Â  small{color:var(--muted)}
Â  Â  .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px;margin-top:16px}
Â  Â  .card{grid-column:span 12;background:var(--card);border-radius:12px;padding:14px;box-shadow:0 6px 18px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.03)}
Â  Â  @media(min-width:900px){ .card.small{grid-column:span 4} .card.medium{grid-column:span 6} .card.large{grid-column:span 12} }
Â  Â  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
Â  Â  .stat{background:var(--glass);padding:10px;border-radius:10px;min-width:140px}
Â  Â  .green{color:var(--green)} .red{color:var(--red)} .accent{color:var(--accent)}
Â  Â  input[type="text"], select{background:#07111a;border:1px solid rgba(255,255,255,0.03);padding:8px;border-radius:8px;color:inherit}
Â  Â  .list{max-height:320px;overflow:auto;margin-top:8px;border-radius:10px}
Â  Â  .item{display:flex;justify-content:space-between;padding:8px;border-bottom:1px dashed rgba(255,255,255,0.03)}
Â  Â  .tiny{font-size:12px;color:var(--muted)}
Â  Â  .chip{padding:6px 8px;border-radius:8px;background:rgba(255,255,255,0.02);font-size:13px}
Â  Â  .btn{background:var(--accent);padding:8px 10px;border-radius:8px;border:none;color:#001019;cursor:pointer}
Â  </style>
</head>
<body>
Â  <div class="wrap">
Â  Â  <header>
Â  Â  Â  <div>
Â  Â  Â  Â  <h1>ðŸ“ˆ OKX USDT Perpetual Tracker</h1>
Â  Â  Â  Â  <small>Public OKX v5 API Â· Perpetual (SWAP) instruments Â· Last updated: <span id="lastUpdated">â€”</span></small>
Â  Â  Â  </div>
Â  Â  Â  <div class="row">
Â  Â  Â  Â  <div class="chip">Network: OKX Public</div>
Â  Â  Â  Â  <div style="width:10px"></div>
Â  Â  Â  Â  <button class="btn" id="refreshBtn">Refresh</button>
Â  Â  Â  </div>
Â  Â  </header>

Â  Â  <div class="grid">
Â  Â  Â  <div class="card small">
Â  Â  Â  Â  <div class="tiny">Market Summary</div>
Â  Â  Â  Â  <div style="margin-top:8px" id="summary">
Â  Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  Â  <div class="stat">
Â  Â  Â  Â  Â  Â  Â  <div class="tiny">Green Pairs</div>
Â  Â  Â  Â  Â  Â  Â  <div id="greenCount" class="accent">â€”</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="stat">
Â  Â  Â  Â  Â  Â  Â  <div class="tiny">Red Pairs</div>
Â  Â  Â  Â  Â  Â  Â  <div id="redCount" class="tiny red">â€”</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="stat">
Â  Â  Â  Â  Â  Â  Â  <div class="tiny">Total Green Liquidity (USDT)</div>
Â  Â  Â  Â  Â  Â  Â  <div id="greenLiquidity" class="green">â€”</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="stat">
Â  Â  Â  Â  Â  Â  Â  <div class="tiny">Total Red Liquidity (USDT)</div>
Â  Â  Â  Â  Â  Â  Â  <div id="redLiquidity" class="red">â€”</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div style="margin-top:10px" class="tiny">Dominant: <strong id="dominantSide">â€”</strong></div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div class="card medium">
Â  Â  Â  Â  <div class="tiny">Transaction Dominance (USDT quote volume)</div>
Â  Â  Â  Â  <div style="display:flex;gap:12px;margin-top:10px;align-items:center;">
Â  Â  Â  Â  Â  <div style="flex:1;padding:8px;background:rgba(255,255,255,0.02);border-radius:8px">
Â  Â  Â  Â  Â  Â  <div class="tiny">Bullish TXN</div>
Â  Â  Â  Â  Â  Â  <div id="greenTxn" class="green" style="font-weight:700">â€”</div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div style="flex:1;padding:8px;background:rgba(255,255,255,0.02);border-radius:8px">
Â  Â  Â  Â  Â  Â  <div class="tiny">Bearish TXN</div>
Â  Â  Â  Â  Â  Â  <div id="redTxn" class="red" style="font-weight:700">â€”</div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div style="flex:0 0 160px">
Â  Â  Â  Â  Â  Â  <div class="tiny">Dominant Side</div>
Â  Â  Â  Â  Â  Â  <div id="txnDominant" class="chip">â€”</div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>

Â  Â  Â  <div class="card large" style="margin-top:12px">
Â  Â  Â  Â  <div style="display:flex;justify-content:space-between;align-items:center">
Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <div class="tiny">TXN Dominance Explorer (OKX SWAP pairs)</div>
Â  Â  Â  Â  Â  Â  <div style="margin-top:6px" class="tiny">Search pair (e.g. BTC-USDT-SWAP) or sort by gap</div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  Â  <input id="search" type="text" placeholder="search symbol" />
Â  Â  Â  Â  Â  Â  <select id="sort">
Â  Â  Â  Â  Â  Â  Â  <option value="desc">Sort gap desc</option>
Â  Â  Â  Â  Â  Â  Â  <option value="asc">Sort gap asc</option>
Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="list" id="pairsList" aria-live="polite"></div>
Â  Â  Â  </div>

Â  Â  Â  <div class="card medium">
Â  Â  Â  Â  <div class="tiny">Weekly Market Rhythm</div>
Â  Â  Â  Â  <div id="weekly" style="margin-top:8px" class="tiny">â€”</div>
Â  Â  Â  </div>

Â  Â  Â  <div class="card medium">
Â  Â  Â  Â  <div class="tiny">ATH Gap / Quick Calculator</div>
Â  Â  Â  Â  <div style="margin-top:8px" class="tiny">
Â  Â  Â  Â  Â  <input id="athSymbol" type="text" placeholder="Symbol (e.g. BTC-USDT-SWAP)" style="width:100%;margin-bottom:6px" />
Â  Â  Â  Â  Â  <input id="athPrice" type="number" placeholder="ATH price" style="width:48%;margin-right:4%" />
Â  Â  Â  Â  Â  <input id="entryPrice" type="number" placeholder="Entry price" style="width:48%" />
Â  Â  Â  Â  Â  <div style="margin-top:8px">
Â  Â  Â  Â  Â  Â  <button id="calc" class="btn">Compute</button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div id="athResult" class="tiny" style="margin-top:10px"></div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  </div>

Â  Â  <footer style="margin-top:18px" class="tiny">
Â  Â  Â  Built for OKX Â· Uses public API v5 endpoints Â· **[FIXED] Now uses a CORS proxy to bypass browser restrictions. For a stable solution, run your own proxy.**
Â  Â  </footer>
Â  </div>

<script>
(() => {
Â  // OKX v5 public base
Â  const OKX_BASE = 'https://www.okx.com';

Â  // ðŸ›‘ THE FIX: Use a CORS Proxy to route the requests and bypass browser restrictions.
Â  // We will encode the OKX_BASE URL and prepend it with a public CORS proxy.
Â  // NOTE: Public CORS proxies like corsproxy.io may be rate-limited or unreliable.
Â  // For production, you should host your own lightweight proxy.
Â  const PROXY_URL = 'https://corsproxy.io/?' + encodeURIComponent(OKX_BASE);

Â  // CENTRALIZED FETCH FUNCTION: All API calls will now go through this.
Â  async function fetchFromOKX(endpoint) {
Â  Â  const fullUrl = PROXY_URL + endpoint; // Append the OKX endpoint to the PROXY URL
Â  Â  // console.log('Fetching:', fullUrl); // Uncomment for debugging
Â  Â  const res = await fetch(fullUrl);
Â  Â  if (!res.ok) throw new Error(\`Failed to fetch from OKX API via proxy. Status: \${res.status}\`);
Â  Â  return res.json();
Â  }


Â  // Element refs (unchanged)
Â  const lastUpdatedEl = document.getElementById('lastUpdated');
Â  const refreshBtn = document.getElementById('refreshBtn');
Â  const greenCountEl = document.getElementById('greenCount');
Â  const redCountEl = document.getElementById('redCount');
Â  const greenLiquidityEl = document.getElementById('greenLiquidity');
Â  const redLiquidityEl = document.getElementById('redLiquidity');
Â  const greenTxnEl = document.getElementById('greenTxn');
Â  const redTxnEl = document.getElementById('redTxn');
Â  const txnDominantEl = document.getElementById('txnDominant');
Â  const dominantSideEl = document.getElementById('dominantSide');
Â  const pairsListEl = document.getElementById('pairsList');
Â  const searchInput = document.getElementById('search');
Â  const sortSelect = document.getElementById('sort');
Â  const weeklyEl = document.getElementById('weekly');

Â  // in-memory storage for weekly pattern (localStorage)
Â  function formatManilaTime() {
Â  Â  return new Date().toLocaleString('en-US', { timeZone: 'Asia/Manila' });
Â  }

Â  // helper: compact format
Â  function fmt(n) {
Â  Â  if (!isFinite(n)) return 'â€”';
Â  Â  const abs = Math.abs(n);
Â  Â  if (abs >= 1e9) return (n/1e9).toFixed(2)+'B';
Â  Â  if (abs >= 1e6) return (n/1e6).toFixed(2)+'M';
Â  Â  if (abs >= 1e3) return (n/1e3).toFixed(2)+'K';
Â  Â  return n.toFixed(2);
Â  }

Â  // Fetch instruments: SWAP (perpetual) that end with -USDT-SWAP
Â  async function fetchSwapInstruments() {
Â  Â  const endpoint = '/api/v5/public/instruments?instType=SWAP';
Â  Â  const j = await fetchFromOKX(endpoint); // â¬…ï¸ USED NEW FETCH FUNCTION
Â  Â  // j.data is array of {instId, baseCcy, quoteCcy, instType, lotSz,...}
Â  Â  return j.data.filter(d => (d.instId && d.instId.endsWith('-USDT-SWAP')));
Â  }

Â  // Fetch tickers for many instruments (comma separated instId).
Â  // OKX supports multiple instId by comma.
Â  async function fetchTickers(instIds) {
Â  Â  const chunk = (arr, n) => {
Â  Â  Â  const out=[]; for(let i=0;i<arr.length;i+=n) out.push(arr.slice(i,i+n)); return out;
Â  Â  };
Â  Â  // OKX allows many, but to be safe chunk by 50
Â  Â  const chunks = chunk(instIds, 50);
Â  Â  let out=[];
Â  Â  for (const c of chunks) {
Â  Â  Â  const q = '/api/v5/market/tickers?instType=SWAP&instIds=' + encodeURIComponent(c.join(','));
Â  Â  Â  const j = await fetchFromOKX(q); // â¬…ï¸ USED NEW FETCH FUNCTION
Â  Â  Â  if (j && j.data) out = out.concat(j.data);
Â  Â  }
Â  Â  // each data item: {instId,last,ask, bid, vol, sodUtc0...}
Â  Â  return out;
Â  }

Â  // Fetch funding rate for a single instrument
Â  async function fetchFundingRate(instId) {
Â  Â  // public funding rate endpoint:
Â  Â  const endpoint = '/api/v5/public/funding-rate?instId=' + encodeURIComponent(instId);
Â  Â  try {
Â  Â  Â  const j = await fetchFromOKX(endpoint); // â¬…ï¸ USED NEW FETCH FUNCTION
Â  Â  Â  // j.data is array; we take the lastFundingRate if present
Â  Â  Â  if (j && j.data && j.data.length > 0) {
Â  Â  Â  Â  // element may have nextFundingRate, fundingRate etc.
Â  Â  Â  Â  const d = j.data[0];
Â  Â  Â  Â  // prefer fundingRate or nextFundingRate or estFundingRate
Â  Â  Â  Â  return parseFloat(d.fundingRate || d.nextFundingRate || d.lastFundingRate || 0);
Â  Â  Â  }
Â  Â  Â  return 0;
Â  Â  } catch (e) {
Â  Â  Â  return 0; // Return 0 on fetch error
Â  Â  }
Â  }

Â  // Main update function
Â  async function updateAll() {
Â  Â  try {
Â  Â  Â  refreshBtn.disabled = true;
Â  Â  Â  refreshBtn.textContent = 'Loading...';
Â  Â  Â  lastUpdatedEl.textContent = formatManilaTime();

Â  Â  Â  // 1) fetch instruments
Â  Â  Â  const instruments = await fetchSwapInstruments();

Â  Â  Â  // For performance, limit to top N by instId alphabetical or by volume later.
Â  Â  Â  // We'll ask tickers for first 200 instruments (or all if small)
Â  Â  Â  const instIds = instruments.map(i => i.instId).slice(0, 200);

Â  Â  Â  // 2) fetch tickers
Â  Â  Â  const tickers = await fetchTickers(instIds);

Â  Â  Â  // Build a map tickerMap[instId] = tickerData
Â  Â  Â  const tickerMap = {};
Â  Â  Â  tickers.forEach(t => {
Â  Â  Â  Â  // OKX ticker fields:
Â  Â  Â  Â  // instId, last, vol (base asset volume), volCcy (quote?), ask, bid, open24h, high24h, low24h, sodUtc0...
Â  Â  Â  Â  const instId = t.instId || t.instId;
Â  Â  Â  Â  tickerMap[instId] = t;
Â  Â  Â  });

Â  Â  Â  // 3) For each instrument assemble symbol info and fetch funding rates in parallel (but limit concurrency)
Â  Â  Â  const limiter = (arr, fn, concurrency = 6) => { // Reduced concurrency for public proxy safety
Â  Â  Â  Â  const results = []; let i=0;
Â  Â  Â  Â  return new Promise((resolve, reject) => {
Â  Â  Â  Â  Â  let running = 0;
Â  Â  Â  Â  Â  function next() {
Â  Â  Â  Â  Â  Â  if (i >= arr.length && running === 0) return resolve(results);
Â  Â  Â  Â  Â  Â  while (running < concurrency && i < arr.length) {
Â  Â  Â  Â  Â  Â  Â  const idx = i++;
Â  Â  Â  Â  Â  Â  Â  running++;
Â  Â  Â  Â  Â  Â  Â  Promise.resolve(fn(arr[idx], idx)).then(r => {
Â  Â  Â  Â  Â  Â  Â  Â  results[idx] = r;
Â  Â  Â  Â  Â  Â  Â  Â  running--; next();
Â  Â  Â  Â  Â  Â  Â  }).catch(err => { running--; results[idx] = { error: err.message || String(err) }; next(); });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  next();
Â  Â  Â  Â  });
Â  Â  Â  };

Â  Â  Â  // prepare array of instrument data to compute (unchanged logic)
Â  Â  Â  const items = instruments.map(inst => {
Â  Â  Â  Â  const ticker = tickerMap[inst.instId] || {};
Â  Â  Â  Â  // determine quote volume in USDT - OKX ticker provides volCcy or vol (check both)
Â  Â  Â  Â  const quoteVol = parseFloat(ticker.volCcy || ticker.volCcy24h || ticker.quoteVol || ticker.volUsd || ticker.vol || 0) || 0;
Â  Â  Â  Â  const priceChange = (() => {
Â  Â  Â  Â  Â  const open24 = parseFloat(ticker.open24h || 0); // Removed || ticker.oi || 0 as oi is Open Interest, not Open Price.
Â  Â  Â  Â  Â  const last = parseFloat(ticker.last || 0);
Â  Â  Â  Â  Â  if (open24 && last) return ((last - open24) / open24) * 100;
Â  Â  Â  Â  Â  // fallback to 0
Â  Â  Â  Â  Â  return parseFloat(ticker.change || 0);
Â  Â  Â  Â  })();
Â  Â  Â  Â  return {
Â  Â  Â  Â  Â  instId: inst.instId,
Â  Â  Â  Â  Â  baseCcy: inst.baseCcy,
Â  Â  Â  Â  Â  quoteCcy: inst.quoteCcy,
Â  Â  Â  Â  Â  priceChangePercent: priceChange,
Â  Â  Â  Â  Â  lastPrice: parseFloat(ticker.last || 0),
Â  Â  Â  Â  Â  volume: quoteVol,
Â  Â  Â  Â  Â  rawTicker: ticker
Â  Â  Â  Â  };
Â  Â  Â  });

Â  Â  Â  // fetch funding rates for those with volume > 0 (limit concurrency)
Â  Â  Â  const withFunding = await limiter(items, async (it, idx) => {
Â  Â  Â  Â  if (!it || !it.instId) return it;
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  // Use the local fetchFundingRate which now uses the proxy
Â  Â  Â  Â  Â  const fr = await fetchFundingRate(it.instId);
Â  Â  Â  Â  Â  return { ...it, fundingRate: (isFinite(fr) ? fr : 0) };
Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  return { ...it, fundingRate: 0 };
Â  Â  Â  Â  }
Â  Â  Â  }, 6); // concurrency limit is set to 6

Â  Â  Â  // rest of logic (unchanged, just relying on the fetched data)

Â  Â  Â  // filter out zero-volume rows
Â  Â  Â  const filtered = withFunding.filter(d => d.volume > 0);

Â  Â  Â  // compute aggregates
Â  Â  Â  const green = filtered.filter(d => d.priceChangePercent >= 0);
Â  Â  Â  const red = filtered.filter(d => d.priceChangePercent < 0);

Â  Â  Â  const greenLiquidityTotal = green.reduce((s, x) => s + (Number(x.volume)||0), 0);
Â  Â  Â  const redLiquidityTotal = red.reduce((s, x) => s + (Number(x.volume)||0), 0);

Â  Â  Â  // "txn" proxy using quote volume
Â  Â  Â  const greenTxnTotal = greenLiquidityTotal;
Â  Â  Â  const redTxnTotal = redLiquidityTotal;

Â  Â  Â  // counts for funding/price combos (unused in UI but kept for integrity)
Â  Â  Â  const gPos = filtered.filter(d => d.priceChangePercent >= 0 && d.fundingRate >= 0).length;
Â  Â  Â  const gNeg = filtered.filter(d => d.priceChangePercent >= 0 && d.fundingRate < 0).length;
Â  Â  Â  const rPos = filtered.filter(d => d.priceChangePercent < 0 && d.fundingRate >= 0).length;
Â  Â  Â  const rNeg = filtered.filter(d => d.priceChangePercent < 0 && d.fundingRate < 0).length;

Â  Â  Â  // determine dominant
Â  Â  Â  const dominantTxn = greenTxnTotal > redTxnTotal ? 'ðŸŸ¢ Bullish (Green)' : redTxnTotal > greenTxnTotal ? 'ðŸ”´ Bearish (Red)' : 'âš« Neutral';

Â  Â  Â  // update UI elements
Â  Â  Â  lastUpdatedEl.textContent = formatManilaTime();
Â  Â  Â  greenCountEl.textContent = String(green.length);
Â  Â  Â  redCountEl.textContent = String(red.length);
Â  Â  Â  greenLiquidityEl.textContent = fmt(greenLiquidityTotal);
Â  Â  Â  redLiquidityEl.textContent = fmt(redLiquidityTotal);
Â  Â  Â  greenTxnEl.textContent = fmt(greenTxnTotal);
Â  Â  Â  redTxnEl.textContent = fmt(redTxnTotal);
Â  Â  Â  txnDominantEl.textContent = dominantTxn;
Â  Â  Â  dominantSideEl.textContent = (greenLiquidityTotal > redLiquidityTotal) ? 'Bullish Liquidity (Green)' : (redLiquidityTotal > greenLiquidityTotal) ? 'Bearish Liquidity (Red)' : 'Balanced';

Â  Â  Â  // Build list items with a simple gap metric (abs difference of buy vs sell proxy using sign)
Â  Â  Â  const enriched = filtered.map(d => {
Â  Â  Â  Â  const greenTxn = d.priceChangePercent >= 0 ? d.volume : 0;
Â  Â  Â  Â  const redTxn = d.priceChangePercent < 0 ? d.volume : 0;
Â  Â  Â  Â  const diff = Math.abs(greenTxn - redTxn);
Â  Â  Â  Â  return { ...d, greenTxn, redTxn, diff };
Â  Â  Â  });

Â  Â  Â  // Sorting & filtering based on UI controls
Â  Â  Â  function renderList() {
Â  Â  Â  Â  const q = (searchInput.value||'').trim().toLowerCase();
Â  Â  Â  Â  const order = sortSelect.value || 'desc';
Â  Â  Â  Â  let list = enriched.slice();
Â  Â  Â  Â  if (q) list = list.filter(x => x.instId.toLowerCase().includes(q));
Â  Â  Â  Â  list.sort((a,b) => order === 'desc' ? b.diff - a.diff : a.diff - b.diff);
Â  Â  Â  Â  // cap to 200
Â  Â  Â  Â  list = list.slice(0, 200);

Â  Â  Â  Â  pairsListEl.innerHTML = '';
Â  Â  Â  Â  if (list.length === 0) pairsListEl.innerHTML = '<div style="padding:12px;color:var(--muted)">No matching pairs.</div>';
Â  Â  Â  Â  list.forEach(item => {
Â  Â  Â  Â  Â  const el = document.createElement('div');
Â  Â  Â  Â  Â  el.className = 'item';
Â  Â  Â  Â  Â  el.innerHTML = \`
Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  <div style="font-weight:600">\${item.instId}</div>
Â  Â  Â  Â  Â  Â  Â  <div class="tiny">\${item.priceChangePercent ? item.priceChangePercent.toFixed(2) + '%' : 'â€”'} &middot; Last: \${item.lastPrice || 'â€”'}</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div style="text-align:right">
Â  Â  Â  Â  Â  Â  Â  <div><span class="green">\${fmt(item.greenTxn)}</span> / <span class="red">\${fmt(item.redTxn)}</span></div>
Â  Â  Â  Â  Â  Â  Â  <div class="tiny">fund: \${(item.fundingRate||0).toFixed(6)}</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  \`;
Â  Â  Â  Â  Â  pairsListEl.appendChild(el);
Â  Â  Â  Â  });
Â  Â  Â  }

Â  Â  Â  // Weekly rhythm logic (persisted in localStorage)
Â  Â  Â  (function updateWeekly() {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  const today = new Date().toLocaleDateString('en-US', { timeZone: 'Asia/Manila' });
Â  Â  Â  Â  Â  const weekday = new Date().toLocaleDateString('en-US', { weekday: 'short', timeZone: 'Asia/Manila' });
Â  Â  Â  Â  Â  const bias = dominantTxn.includes('Bullish') ? 'ðŸŸ©' : dominantTxn.includes('Bearish') ? 'ðŸŸ¥' : 'âš«';
Â  Â  Â  Â  Â  let history = JSON.parse(localStorage.getItem('okxMarketHistory') || '[]');
Â  Â  Â  Â  Â  const existing = history.find(h => h.date === today);
Â  Â  Â  Â  Â  if (existing) { existing.bias = bias; existing.day = weekday; } else { history.push({ date: today, bias, day: weekday }); }
Â  Â  Â  Â  Â  if (history.length > 14) history = history.slice(-14);
Â  Â  Â  Â  Â  localStorage.setItem('okxMarketHistory', JSON.stringify(history));
Â  Â  Â  Â  Â  const currentWeek = history.slice(-7);
Â  Â  Â  Â  Â  const greens = currentWeek.filter(h => h.bias === 'ðŸŸ©').length;
Â  Â  Â  Â  Â  const reds = currentWeek.filter(h => h.bias === 'ðŸŸ¥').length;
Â  Â  Â  Â  Â  const pattern = currentWeek.map(h => h.bias + ' ' + h.day).join(' â€¢ ');
Â  Â  Â  Â  Â  let phase = 'Rotation Phase ðŸ”„';
Â  Â  Â  Â  Â  if (greens >= 5 && reds <= 2) phase = 'Alt Season Building ðŸŒ±';
Â  Â  Â  Â  Â  else if (reds >= 5 && greens <= 2) phase = 'Cooling Phase â„ï¸';
Â  Â  Â  Â  Â  else if (greens === reds) phase = 'Balanced Market âš–ï¸';
Â  Â  Â  Â  Â  weeklyEl.textContent = pattern + ' â€” ' + phase + ' (' + greens + ' green / ' + reds + ' red)';
Â  Â  Â  Â  } catch(e) { weeklyEl.textContent = 'â€”'; }
Â  Â  Â  })();

Â  Â  Â  // finally render list
Â  Â  Â  renderList();

Â  Â  Â  // attach search/sort handlers
Â  Â  Â  searchInput.oninput = renderList;
Â  Â  Â  sortSelect.onchange = renderList;

Â  Â  } catch (err) {
Â  Â  Â  console.error('updateAll error', err);
Â  Â  Â  pairsListEl.innerHTML = '<div style="padding:12px;color:var(--red)">ðŸš¨ Error fetching OKX data: ' + (err.message || 'Check console for details.') + ' This is likely a **CORS/Proxy error**.</div>';
Â  Â  } finally {
Â  Â  Â  refreshBtn.disabled = false;
Â  Â  Â  refreshBtn.textContent = 'Refresh';
Â  Â  }
Â  }

Â  // initial load
Â  updateAll();

Â  // set interval to refresh (30s)
Â  let timer = setInterval(updateAll, 30000);
Â  refreshBtn.addEventListener('click', () => { updateAll(); clearInterval(timer); timer = setInterval(updateAll, 30000); });

Â  // ath calculator UI (unchanged)
Â  document.getElementById('calc').addEventListener('click', () => {
Â  Â  const symbol = document.getElementById('athSymbol').value.trim();
Â  Â  const ath = parseFloat(document.getElementById('athPrice').value);
Â  Â  const entry = parseFloat(document.getElementById('entryPrice').value);
Â  Â  const out = document.getElementById('athResult');
Â  Â  if (!ath || !entry || ath <= 0 || entry <= 0) { out.textContent = 'Please enter ATH and Entry prices > 0'; return; }
Â  Â  const gap = ((ath - entry) / ath) * 100;
Â  Â  const roi = ((ath - entry) / entry) * 100;
Â  Â  out.innerHTML = \`Symbol: \${symbol || 'â€”'} â€¢ \${gap.toFixed(2)}% below ATH â€¢ Potential ROI to ATH: \${roi.toFixed(2)}%\`;
Â  });

})();
</script>
</body>
</html>
